(function(t){(function(t){t(["config","app/core","app/wig-ui","jquery","backbone","jst/jst-edit","wysiwyg","bootstrap","link!css/wig.font-awesome.css","js!//api.filepicker.io/v1/filepicker.js"],function(e,n,i,s,a,o){var l,c=window,r={},d=s.fn.removeClass;return s.fn.removeClass=function(){return d.apply(this,arguments),this.filter(function(){return""===s(this).attr("class")}).removeAttr("class"),this},i.showSave(),i.delegateEvents({"click #ww-save":function(t){t.preventDefault(),l.stopEditElem(),l.promptSave()}}),c.filepicker.setKey("AD2mNTSDmQGOstfQiUkyWz"),r.Overlay=new(a.View.extend({tagName:"div",id:"ww-overlay",template:o["wig-overlay"],events:{"click .ww-panel":"close"},render:function(){return this.$el.append(this.template()),this.$el.hide(),this.$top=this.$("#ww-overlay-top"),this.$right=this.$("#ww-overlay-right"),this.$bottom=this.$("#ww-overlay-bottom"),this.$left=this.$("#ww-overlay-left"),this},showAround:function(t){var e=this;this.$el.show(),this.adjustPosition(t),this.interval=c.setInterval(function(){e.adjustPosition(t)},500)},adjustPosition:function(t){var e,n,i,a,o,l=s(t);e=l.offset(),n=e.top,i=e.left,a=l.outerWidth(),o=l.outerHeight(),page_height=s(c.document).height(),this.$top.css({height:n}),this.$right.css({top:n,height:o,left:i+a}),this.$bottom.css({top:n+o,height:page_height-o-n}),this.$left.css({top:n,height:o,width:i})},hide:function(){this.$el.hide();try{c.clearInterval(this.interval)}catch(t){}},close:function(t){t.stopPropagation(),t.preventDefault(),l.stopEditElem(),l.beginEdit()}})),r.SavePopup=new(a.View.extend({tagName:"div",id:"ww-save-popup",template:o["wig-save-popup"],events:{"click #ww-save-save":function(t){t.preventDefault(),l.saveChanges()},"click #ww-save-cancel":function(t){t.preventDefault(),this.$el.hide()}},render:function(){return this.$el.append(this.template(e)).hide(),this}})),r.Controls=new(a.View.extend({tagName:"div",id:"ww-edit-controls",template:o["wig-edit-controls"],events:{"click a":function(t){t.preventDefault()},"click #ww-ec-undo":function(){l.undo()},"click #ww-ec-redo":function(){l.redo()},"click #ww-ec-copy":function(){l.cloneEditElem(!0)},"click #ww-ec-dumbcopy":function(){l.cloneEditElem(!1)},"click #ww-ec-remove":function(){l.removeEditElem(),l.beginEdit()},"click #ww-ec-ok":function(){l.stopEditElem(),l.beginEdit()}},render:function(){return this.$el.append(this.template()),this}})),r.LinkChanger=new(a.View.extend({tagname:"div",id:"ww-edit-link",template:o["wig-link-changer"],events:{"click #ww-link-update":"changeLink"},render:function(){return this.$el.append(this.template()).hide(),this},showOn:function(t){var e=s(t),n=e.offset();this.$el.show().css({top:n.top+e.height()+20,left:n.left}),this.$("#ww-link-href").val(t.href)},changeLink:function(t){var e=this.$("#ww-link-href").val();t.preventDefault(),l.$editing_elem.attr("href",e)}})),r.FilePickerUI=new(a.View.extend({tagName:"div",id:"ww-change-image",template:o["wig-file-picker"],events:{"click #ww-change-image-change":"changeImage"},render:function(){return this.$el.append(this.template()).hide(),this},showOn:function(t){var e=s(t),n=e.offset();this.$el.show().css({top:n.top+e.height()+20,left:n.left})},changeImage:function(t){t.preventDefault(),l.editing&&c.filepicker.pickAndStore({multiple:!1},{access:"store"},function(t){l.$editing_elem.attr("src",t[0].url)})}})),r.TextEditor=new(a.View.extend({tagName:"div",id:"ww-text-editor",template:o["wig-text-editor"],events:{},render:function(){return this.$el.append(this.template()).hide(),this.$(".dropdown-menu input").click(function(){return!1}).change(function(){s(this).parent(".dropdown-menu").siblings(".dropdown-toggle").dropdown("toggle")}).keydown("esc",function(){this.value="",s(this).change()}),this},showOn:function(t){var e,i=n.getPath(t),a=s(t),o=a.offset();this.$el.show(),e=this.$el.height()+20,this.$el.css({top:o.top-e,left:o.left,position:"absolute"}),this.$(".btn-toolbar").attr("data-target",i),a.wysiwyg()}})),t("app/edit-ui",[],r),l={changes:[],cursor:-1,addChange:function(t,e,n,i,a,o){t=s.isArray(t)?t:[t],i=s.isArray(i)?i:[i],a=a||e,o=o||n,this.changes=this.changes.slice(0,this.cursor+1),this.changes.push({path:e,method:n,args:t,rev:{path:a,method:o,args:i}}),this.cursor+=1},applyChange:function(t){s.prototype[t.method].apply(s(t.path),t.args)},undo:function(){var t,e=!1,i=!1;return this.editing&&(this.stopEditElem(),e=!0,t=n.getPath(this.$editing_elem[0])),this.cursor>=0&&(this.applyChange(this.changes[this.cursor].rev),"remove"===this.changes[this.cursor].rev.method&&(i=!0),this.cursor-=1),e&&!i?this.editElem(s(t)[0]):e&&this.beginEdit(),this.cursor>=0?!0:!1},redo:function(){return this.editing?void 0:(this.cursor<this.changes.length-1&&(this.applyChange(this.changes[this.cursor+1]),this.cursor+=1),this.cursor<this.changes.length-1?!0:!1)},dumpChanges:function(){var t,e,n,i,s,a="",o=this.cursor,l=this.prepString;for(t=0;o>=t;t++){for(e=this.changes[t],i=e.args.length,a+="$('"+l(e.path)+"')."+e.method+"(",n=0;i>n;n++)s=e.args[n],n>0&&(a+=","),"string"==typeof s&&(a+="'"+l(s)+"'");a+=");"}return a},prepString:function(t){return t.replace(/\r\n|\r|\n/g,"\\n").replace(/'/g,"\\'")},startEdit:function(){this.editable=document.body||s("body")[0],r.Overlay.render().$el.prependTo(i.el),r.Controls.render().$el.appendTo(i.el),r.SavePopup.render().$el.appendTo(i.el),n.$getElems("*").unbind().click(function(t){t.preventDefault()}),e.batch+=1,this.beginEdit()},initUI:function(){var t,e=c.document.createDocumentFragment();for(t in r)e.appendChild(r[t].render().el);i.$el.append(e)},stopEdit:function(){this.stopEditElem(),n.PickElem.stop()},beginEdit:function(){n.PickElem.start(function(){l.editElem(this)})},editElem:function(t){var e,n,i,a=s(t),o=a.css("display"),l=t.style.display;if(s.data(t,{old_display:l,has_style:t.hasAttribute("style")}),a.is(s("body"))||a.is(s("html")))return this.beginEdit(),void 0;for(this.$editing_elem=a,this.editing=!0,this.storeHTML(t,"o_html"),"inline"===o&&a.css("display","inline-block"),r.Overlay.showAround(t),e=0,n=this.modals.length;n>e;e++)if(i=this.modals[e],s.inArray(t.tagName,i.tags)>=0||0===i.tags.length)try{i.view.showOn(t)}catch(c){i.view.$el.show()}},stopEditElem:function(t){if(this.editing){var e,i=this.$editing_elem;i.parent(),i.stopWysiwyg(),this.storeHTML(i[0],"n_html"),this.storeHTML(i.parent()[0],"n_html"),t||s.data(i[0],"o_html")!==s.data(i[0],"n_html")&&(e=i[0],this.addChange(s.data(e,"n_html"),n.getPath(e),"replaceWith",s.data(e,"o_html"))),r.Overlay.hide(),r.FilePickerUI.$el.hide(),r.TextEditor.$el.hide(),l.editing=!1;for(var a=0,o=this.modals.length;o>a;a++)this.modals[a].view.$el.hide()}},cloneEditElem:function(t){if(this.editing){var e,i;if(this.stopEditElem(),t){var a,o=this.$editing_elem,l=o.siblings();0===l.filter(o[0].tagName).length&&this.$editing_elem.parentsUntil("body").each(function(){return a=s(this),a.siblings().filter(this.tagName).length>0?(o=a,!1):void 0}),i=o}else i=this.$editing_elem;e=i.clone();var c=e.attr("id"),r=0,d=c;if(c){for(;s("#"+d).length>0;)r+=1,d=c+r;e.attr("id",d)}e.insertAfter(i),this.addChange(n.getPath(i[0]),e[0].outerHTML,"insertAfter",[],n.getPath(e[0]),"remove"),this.editElem(e[0])}},removeEditElem:function(){if(this.editing){this.stopEditElem();var t,e=this.$editing_elem[0].outerHTML,i=this.$editing_elem.prev(),s="insertAfter";0===i.length&&(i=this.$editing_elem.parent(),s="prependTo"),t=n.getPath(i[0]),this.addChange([],n.getPath(this.$editing_elem[0]),"remove",t,e,s),this.$editing_elem.remove()}},storeHTML:function(t,e){s.data(t,e,t.outerHTML)},captureState:function(){var t=this.getAll();t.each(function(){s.data(this,{o_path:n.getPath(this),o_elem:this})})},getAll:function(){return s(this.editable).find("*").addBack().not(i.$("*").addBack())},promptSave:function(){var t=r.SavePopup;t.$el.show(),t.$("#ww-save-desc").focus()},saveChanges:function(){var t,n=this.dumpChanges(),i=window.location.href,a=window.location.hostname,o=(window.location.host,window.location.pathname),d=(window.location.search,a.split(".")),h=d.length,p=d.slice(h-2,h).join("."),m=d.slice(0,h-2).join(".");m="www"===m?"":m,t={domain:p,subdomain:m,href:i,pathname:o,batch:e.batch,access_code:e.access_code,url:c.location.href,change:n,description:r.SavePopup.$("#ww-save-desc").val(),save_url:e.save_url},e.iframe?(c.parent.postMessage(t,e.ww_app),r.SavePopup.$("#ww-save-form").hide(),r.SavePopup.$(".ww-spinner").show()):s.post(e.save_url,t,function(){alert("CHANGES SAVED OK"),l.endSave()})},endSave:function(){r.SavePopup.$el.hide(),r.SavePopup.$("#ww-save-desc").text("")},editUI:r,addControl:function(t,e,n){r.Controls.$el.append('<a id="'+e+'" href="#">'+t+"</a>"),r.Controls.events["click #"+e]=n,r.Controls.delegateEvents(r.Controls.events)},modals:[],addModal:function(t,e){t.render().$el.hide().appendTo(i.el),this.modals.push({view:t,tags:e})}},l.addModal(r.TextEditor,[]),l.addModal(r.FilePickerUI,["IMG"]),l.addModal(r.LinkChanger,["A"]),l})})("function"==typeof t&&t.amd?t:function(t){module.exports=t(require)})})(_wig.define);