(function(t){t(["jquery","jqhotkeys"],function(t){(function(t){"use strict";var e=function(e){var n=t.Deferred(),i=new FileReader;return i.onload=function(t){n.resolve(t.target.result)},i.onerror=n.reject,i.onprogress=n.notify,i.readAsDataURL(e),n.promise()};t.fn.cleanHtml=function(){var e=t(this).html();return e&&e.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},t.fn.stopWysiwyg=function(){var e,n,i=this,s=function(){i.unbind("keydown").unbind("keyup")},o=function(t,e){t.find(n).unbind("click",a.f1),t.find("[data-toggle=dropdown]").unbind("click",a.restoreSelection),t.find("input[type=text][data-"+e.commandRole+"]").unbind("webkitspeechchange change",a.f2).unbind("focus",a.f3).unbind("blur",a.f4),t.find("input[type=file][data-"+e.commandRole+"]").unbind("change",a.f5)},r=function(){i.unbind("dragenter dragover").unbind("drop",a.f6)};e=t.extend({},t.fn.wysiwyg.defaults);var a=t.fn.wysiwyg.defaults.fns;return t.data(i[0],"wysiwig-started")&&(n="a[data-"+e.commandRole+"],button[data-"+e.commandRole+"],input[type=button][data-"+e.commandRole+"]",s(e.hotKeys),e.dragAndDropImages&&r(),o(t(e.toolbarSelector),e),i.removeAttr("contenteditable").unbind("mouseup keyup mouseout"),t.data(i[0],"wysiwig-started",!1)),this},t.fn.wysiwyg=function(n){var i,s,o,r=this,a=function(){s.activeToolbarClass&&t(s.toolbarSelector).find(o).each(function(){var e=t(this).data(s.commandRole);document.queryCommandState(e)?t(this).addClass(s.activeToolbarClass):t(this).removeClass(s.activeToolbarClass)})},l=function(t,e){var n=t.split(" "),i=n.shift(),s=n.join(" ")+(e||"");document.execCommand(i,0,s),a()},c=function(e){t.each(e,function(t,e){r.keydown(t,function(t){r.attr("contenteditable")&&r.is(":visible")&&(t.preventDefault(),t.stopPropagation(),l(e))}).keyup(t,function(t){r.attr("contenteditable")&&r.is(":visible")&&(t.preventDefault(),t.stopPropagation())})})},h=function(){var t=window.getSelection();return t.getRangeAt&&t.rangeCount?t.getRangeAt(0):void 0},u=function(){i=h()},d=function(){var t=window.getSelection();if(i){try{t.removeAllRanges()}catch(e){document.body.createTextRange().select(),document.selection.empty()}t.addRange(i)}},p=function(n){r.focus(),t.each(n,function(n,i){/^image\//.test(i.type)?t.when(e(i)).done(function(t){l("insertimage",t)}).fail(function(t){s.fileUploadError("file-reader",t)}):s.fileUploadError("unsupported-file-type",i.type)})},f=function(t,e){d(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",0,e||"transparent"),u(),t.data(s.selectionMarker,e)},m=function(){d(),r.focus(),l(t(this).data(s.commandRole)),u()},g=function(){var e=this.value;this.value="",d(),e&&(r.focus(),l(t(this).data(s.commandRole),e)),u()},v=function(){var e=t(this);e.data(s.selectionMarker)||(f(e,s.selectionColor),e.focus())},b=function(){var e=t(this);e.data(s.selectionMarker)&&f(e,!1)},w=function(){d(),"file"===this.type&&this.files&&this.files.length>0&&p(this.files),u(),this.value=""},y=function(t){var e=t.originalEvent.dataTransfer;t.stopPropagation(),t.preventDefault(),e&&e.files&&e.files.length>0&&p(e.files)},k=function(t,e){t.find(o).click(m),t.find("[data-toggle=dropdown]").click(d),t.find("input[type=text][data-"+e.commandRole+"]").on("webkitspeechchange change",g).on("focus",v).on("blur",b),t.find("input[type=file][data-"+e.commandRole+"]").change(w)},x=function(){r.on("dragenter dragover",!1).on("drop",y)};s=t.extend({},t.fn.wysiwyg.defaults,n),o="a[data-"+s.commandRole+"],button[data-"+s.commandRole+"],input[type=button][data-"+s.commandRole+"]",c(s.hotKeys),s.dragAndDropImages&&x(),k(t(s.toolbarSelector),s),r.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){u(),a()}),t(window).bind("touchend",function(t){var e=r.is(t.target)||r.has(t.target).length>0,n=h(),i=n&&n.startContainer===n.endContainer&&n.startOffset===n.endOffset;(!i||e)&&(u(),a())});var _={f1:m,f2:g,f3:v,f4:b,f5:w,f6:y,restoreSelection:d};return t.fn.wysiwyg.defaults.fns=_,t.data(r[0],"wysiwig-started",!0),this},t.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,fileUploadError:function(t,e){console.log("File upload error",t,e)}}})(t)})})(_wig.define);